From 9bda8b15b30f1748c3f3b5ff06450992343b08fd Mon Sep 17 00:00:00 2001
From: Marcus Comstedt <marcus@mc.pp.se>
Date: Tue, 15 Jul 2025 12:55:13 +0200
Subject: [PATCH 1/2] dav1d base ppc64 patch

---
 .../chromium/third_party/dav1d/BUILD.gn       | 24 +++++++++++++
 .../dav1d/config/linux/ppc64/config.h         | 35 +++++++++++++++++++
 .../third_party/dav1d/dav1d_generated.gni     |  1 +
 .../third_party/dav1d/generate_configs.py     |  1 +
 .../third_party/dav1d/generate_source.py      |  1 +
 .../dav1d/libdav1d/src/ppc/dav1d_types.h      | 15 ++++++++
 6 files changed, 77 insertions(+)
 create mode 100644 src/3rdparty/chromium/third_party/dav1d/config/linux/ppc64/config.h

diff --git a/src/3rdparty/chromium/third_party/dav1d/BUILD.gn b/src/3rdparty/chromium/third_party/dav1d/BUILD.gn
index 22a80ef96a..f6540c039c 100644
--- a/src/3rdparty/chromium/third_party/dav1d/BUILD.gn
+++ b/src/3rdparty/chromium/third_party/dav1d/BUILD.gn
@@ -171,6 +171,8 @@ static_library("dav1d_8bit") {
     sources += arm_template_sources
   } else if (current_cpu == "arm64") {
     sources += arm_template_sources
+  } else if (current_cpu == "ppc64") {
+    sources += ppc64_template_sources
   }
 
   cflags = dav1d_copts
@@ -201,6 +203,8 @@ static_library("dav1d_10bit") {
     sources += arm_template_sources
   } else if (current_cpu == "arm64") {
     sources += arm_template_sources
+  } else if (current_cpu == "ppc64") {
+    sources += ppc64_template_sources
   }
 
   cflags = dav1d_copts
@@ -255,6 +259,24 @@ if (current_cpu == "x86" || current_cpu == "x64") {
 
     cflags = dav1d_copts
 
+    deps = [ ":dav1d_headers" ]
+    allow_circular_includes_from = [ ":dav1d_headers" ]
+  }
+} else if (current_cpu == "ppc64") {
+  static_library("dav1d_ppc") {
+    sources = [
+      "libdav1d/src/ppc/cpu.c",
+      "libdav1d/src/ppc/cpu.h",
+    ]
+
+    configs -= [ "//build/config/compiler:chromium_code" ]
+    configs += [
+      "//build/config/compiler:no_chromium_code",
+      ":dav1d_config",
+    ]
+
+    cflags = dav1d_copts
+
     deps = [ ":dav1d_headers" ]
     allow_circular_includes_from = [ ":dav1d_headers" ]
   }
@@ -288,5 +310,7 @@ static_library("dav1d") {
     }
   } else if (current_cpu == "arm" || current_cpu == "arm64") {
     deps += [ ":dav1d_arm" ]
+  } else if (current_cpu == "ppc64") {
+    deps += [ ":dav1d_ppc" ]
   }
 }
diff --git a/src/3rdparty/chromium/third_party/dav1d/config/linux/ppc64/config.h b/src/3rdparty/chromium/third_party/dav1d/config/linux/ppc64/config.h
new file mode 100644
index 0000000000..f6ca57f7f0
--- /dev/null
+++ b/src/3rdparty/chromium/third_party/dav1d/config/linux/ppc64/config.h
@@ -0,0 +1,35 @@
+/*
+ * Autogenerated by the Meson build system.
+ * Do not edit, your changes will be lost.
+ */
+
+#pragma once
+
+#define ARCH_AARCH64 0
+
+#define ARCH_ARM 0
+
+#define ARCH_PPC64LE 1
+
+#define ARCH_X86 0
+
+#define ARCH_X86_32 0
+
+#define ARCH_X86_64 0
+
+#define CONFIG_16BPC 1
+
+#define CONFIG_8BPC 1
+
+#define CONFIG_LOG 1
+
+#define ENDIANNESS_BIG 0
+
+#define HAVE_ASM 1
+
+#define HAVE_GETAUXVAL 1
+
+#define HAVE_POSIX_MEMALIGN 1
+
+#define HAVE_UNISTD_H 1
+
diff --git a/src/3rdparty/chromium/third_party/dav1d/dav1d_generated.gni b/src/3rdparty/chromium/third_party/dav1d/dav1d_generated.gni
index 4518b1f57f..2f2dfce433 100644
--- a/src/3rdparty/chromium/third_party/dav1d/dav1d_generated.gni
+++ b/src/3rdparty/chromium/third_party/dav1d/dav1d_generated.gni
@@ -97,6 +97,7 @@ arm64_asm_sources = [
 ]
 
 arm_template_sources = []
+ppc64_template_sources = []
 template_sources = [
   "libdav1d/src/cdef_apply_tmpl.c",
   "libdav1d/src/cdef_tmpl.c",
diff --git a/src/3rdparty/chromium/third_party/dav1d/generate_configs.py b/src/3rdparty/chromium/third_party/dav1d/generate_configs.py
index 85db9acc9e..aef39c92dd 100755
--- a/src/3rdparty/chromium/third_party/dav1d/generate_configs.py
+++ b/src/3rdparty/chromium/third_party/dav1d/generate_configs.py
@@ -216,6 +216,7 @@ def main():
     linux_env = os.environ
     linux_env['CC'] = 'clang'
 
+    GenerateConfig('config/linux/ppc64', linux_env)
     GenerateConfig('config/linux/x64', linux_env)
 
     noasm_dir = 'config/linux-noasm/x64'
diff --git a/src/3rdparty/chromium/third_party/dav1d/generate_source.py b/src/3rdparty/chromium/third_party/dav1d/generate_source.py
index 65670b0f23..7c09d99924 100755
--- a/src/3rdparty/chromium/third_party/dav1d/generate_source.py
+++ b/src/3rdparty/chromium/third_party/dav1d/generate_source.py
@@ -55,6 +55,7 @@ def _WriteGn(fd):
         fd, "arm64_asm_sources", _Glob("libdav1d/src/arm/64/*.S"),
         _Glob("libdav1d/src/arm/64/*_tmpl.S") + ["libdav1d/src/arm/64/util.S"])
     _WriteArray(fd, "arm_template_sources", _Glob("libdav1d/src/arm/*_tmpl.c"))
+    _WriteArray(fd, "ppc64_template_sources", _Glob("libdav1d/src/ppc/*_tmpl.c"))
 
     template_sources = _Glob("libdav1d/src/*_tmpl.c")
     _WriteArray(fd, "template_sources", template_sources)
diff --git a/src/3rdparty/chromium/third_party/dav1d/libdav1d/src/ppc/dav1d_types.h b/src/3rdparty/chromium/third_party/dav1d/libdav1d/src/ppc/dav1d_types.h
index 9a8bc7a732..7a6ca8d1bb 100644
--- a/src/3rdparty/chromium/third_party/dav1d/libdav1d/src/ppc/dav1d_types.h
+++ b/src/3rdparty/chromium/third_party/dav1d/libdav1d/src/ppc/dav1d_types.h
@@ -55,4 +55,19 @@
 #define u16l_to_i32(v) ((i32x4) vec_mergel((u16x8) v, vec_splat_u16(0)))
 #define i16l_to_i32(v) ((i32x4) vec_unpackl((i16x8)v))
 
+#if defined(__clang__)
+#undef vec_splats
+#define vec_splats(N)                     \
+    _Generic((N),                         \
+        unsigned char:      ((u8x16)(N)), \
+        signed char:        ((i8x16)(N)), \
+        unsigned short:     ((u16x8)(N)), \
+        signed short:       ((i16x8)(N)), \
+        unsigned int:       ((u32x4)(N)), \
+        signed int:         ((i32x4)(N)), \
+        unsigned long long: ((u64x2)(N)), \
+        signed long long:   ((i64x2)(N))  \
+    )
+#endif
+
 #endif /* DAV1D_SRC_PPC_TYPES_H */
-- 
2.52.0


From 71f0152e1dcf39b29fa11a2dd87ff706829a1d7d Mon Sep 17 00:00:00 2001
From: Marcus Comstedt <marcus@mc.pp.se>
Date: Wed, 6 Jan 2021 13:16:45 +0100
Subject: [PATCH 2/2] Subject: [PATCH] Interpret "ppc64" as big endian

---
 src/3rdparty/chromium/third_party/dav1d/BUILD.gn          | 4 ++++
 .../third_party/dav1d/config/linux/ppc64/config.h         | 8 +++++---
 .../chromium/third_party/dav1d/libdav1d/src/cpu.h         | 2 +-
 3 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/src/3rdparty/chromium/third_party/dav1d/BUILD.gn b/src/3rdparty/chromium/third_party/dav1d/BUILD.gn
index f6540c039c..f0cbe5ee00 100644
--- a/src/3rdparty/chromium/third_party/dav1d/BUILD.gn
+++ b/src/3rdparty/chromium/third_party/dav1d/BUILD.gn
@@ -111,6 +111,10 @@ if (is_clang && (current_cpu == "arm" || current_cpu == "arm64")) {
   }
 }
 
+if (current_cpu == "ppc64") {
+  dav1d_copts += [ "-maltivec", "-mvsx" ]
+}
+
 if (enable_nasm) {
   nasm_assemble("dav1d_asm") {
     sources = x86_asm_sources
diff --git a/src/3rdparty/chromium/third_party/dav1d/config/linux/ppc64/config.h b/src/3rdparty/chromium/third_party/dav1d/config/linux/ppc64/config.h
index f6ca57f7f0..c3138078ab 100644
--- a/src/3rdparty/chromium/third_party/dav1d/config/linux/ppc64/config.h
+++ b/src/3rdparty/chromium/third_party/dav1d/config/linux/ppc64/config.h
@@ -9,7 +9,9 @@
 
 #define ARCH_ARM 0
 
-#define ARCH_PPC64LE 1
+#define ARCH_PPC64LE 0
+
+#define ARCH_PPC64 1
 
 #define ARCH_X86 0
 
@@ -23,9 +25,9 @@
 
 #define CONFIG_LOG 1
 
-#define ENDIANNESS_BIG 0
+#define ENDIANNESS_BIG 1
 
-#define HAVE_ASM 1
+#define HAVE_ASM 0
 
 #define HAVE_GETAUXVAL 1
 
diff --git a/src/3rdparty/chromium/third_party/dav1d/libdav1d/src/cpu.h b/src/3rdparty/chromium/third_party/dav1d/libdav1d/src/cpu.h
index 5d712bbbef..2e3d902b35 100644
--- a/src/3rdparty/chromium/third_party/dav1d/libdav1d/src/cpu.h
+++ b/src/3rdparty/chromium/third_party/dav1d/libdav1d/src/cpu.h
@@ -39,7 +39,7 @@
 #include "src/arm/cpu.h"
 #elif ARCH_LOONGARCH
 #include "src/loongarch/cpu.h"
-#elif ARCH_PPC64LE
+#elif ARCH_PPC64LE || ARCH_PPC64
 #include "src/ppc/cpu.h"
 #elif ARCH_RISCV
 #include "src/riscv/cpu.h"
-- 
2.52.0

